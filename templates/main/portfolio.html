{% extends 'base.html' %}
{% load static %}

{% block title %}Portfolio - JCORP{% endblock %}

{% block content %}
<div class="page-content dossier-page">
    <div class="container">
        <!-- Single Project Document -->
        {% if selected_project %}
        <div class="dossier-document-container">
            <!-- Folder Tabs (FBI Dossier Style) - Sitting on document -->
                    <div class="dossier-folder-tabs-wrapper">
                        <div class="dossier-folder-tabs" id="folder-tabs">
                            {% for project in projects %}
                            <div class="folder-tab {% if forloop.counter > 4 %}hidden-tab{% endif %} {% if selected_project.id == project.id %}active{% endif %}" 
                                 data-project-id="{{ project.id }}"
                                 data-project-title="{{ project.title }}"
                                 data-project-index="{{ forloop.counter }}"
                                 title="{{ project.title }}">
                                <span class="tab-number">{{ forloop.counter }}</span>
                                <span class="tab-title">{{ project.title|truncatewords:3 }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        <!-- More Tabs Indicator -->
                        <div class="more-tabs-tab" id="more-tabs-tab" style="display: none;">
                            <span class="tab-number">+<span id="more-tabs-count">0</span></span>
                            <span class="tab-title">MORE</span>
                        </div>
                        <!-- Tabs Dropdown Menu -->
                        <div class="tabs-dropdown" id="tabs-dropdown">
                            <div class="dropdown-header">
                                <span class="dropdown-title">SELECT PROJECT</span>
                                <button class="dropdown-close" id="dropdown-close">&times;</button>
                            </div>
                            <div class="dropdown-list" id="dropdown-list">
                                {% for project in projects %}
                                <div class="dropdown-item {% if selected_project.id == project.id %}active{% endif %}" 
                                     data-project-id="{{ project.id }}">
                                    <span class="item-number">{{ forloop.counter }}</span>
                                    <span class="item-title">{{ project.title }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
            
            <div class="file-document">
                <div class="document-header">
                    <div class="document-meta">
                        <span class="meta-label">CLASSIFICATION:</span>
                        <span class="meta-value">{{ selected_project.classification }}</span>
                    </div>
                    <div class="document-meta">
                        <span class="meta-label">DATE:</span>
                        <span class="meta-value">{{ selected_project.created_date|date:"Y-m-d" }}</span>
                    </div>
                    <div class="document-meta">
                        <span class="meta-label">FILE #:</span>
                        <span class="meta-value">{{ selected_project.id }}</span>
                    </div>
                </div>
                
                <div class="document-body">
                    <h1 class="document-title">{{ selected_project.title }}</h1>
                    
                    <!-- Cover Photo Section -->
                    <div class="document-section cover-photo-section">
                        <span class="section-label">COVER PHOTO:</span>
                        <div class="cover-photo-container">
                            {% if selected_project.featured_image %}
                            <img src="{{ selected_project.featured_image.url }}" alt="{{ selected_project.title }}" class="cover-photo">
                            {% else %}
                            <img src="{% static 'images/project-cover-placeholder.svg' %}" alt="Cover Photo Placeholder" class="cover-photo cover-photo-placeholder">
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if selected_project.project_type %}
                    <div class="document-section">
                        <span class="section-label">PROJECT TYPE:</span>
                        <span class="section-value">{{ selected_project.project_type }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="document-section">
                        <span class="section-label">DESCRIPTION:</span>
                        <p class="section-content">{{ selected_project.description|linebreaks }}</p>
                    </div>
                    
                    {% with tech_list=selected_project.get_technologies_list %}
                    {% if tech_list %}
                    <div class="document-section">
                        <span class="section-label">TECHNOLOGIES:</span>
                        <div class="tech-list">
                            {% for tech in tech_list %}
                            <span class="tech-item">{{ tech }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}
                    
                    {% if selected_project.images.all %}
                    <div class="document-section">
                        <span class="section-label">ADDITIONAL IMAGES:</span>
                        <div class="image-gallery">
                            {% for img in selected_project.images.all %}
                            <div class="gallery-item">
                                <img src="{{ img.image.url }}" alt="{{ img.caption|default:selected_project.title }}">
                                {% if img.caption %}
                                <p class="image-caption">{{ img.caption }}</p>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- White Paper and Specifications Section -->
                    {% if selected_project.white_paper or selected_project.specifications %}
                    <div class="document-section documentation-section">
                        <span class="section-label">DOCUMENTATION:</span>
                        
                        {% if selected_project.white_paper %}
                        <div class="documentation-item">
                            <div class="doc-header">
                                <span class="doc-icon">ðŸ“„</span>
                                <span class="doc-title">WHITE PAPER / SPECIFICATIONS</span>
                            </div>
                            <div class="doc-content">
                                <a href="{{ selected_project.white_paper.url }}" target="_blank" class="doc-download-link">
                                    <span class="doc-action">DOWNLOAD</span>
                                    <span class="doc-filename">WHITE PAPER</span>
                                </a>
                                <a href="{{ selected_project.white_paper.url }}" target="_blank" class="doc-view-link">
                                    <span class="doc-action">VIEW</span>
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if selected_project.specifications %}
                        <div class="documentation-item specifications-item">
                            <div class="doc-header">
                                <span class="doc-icon">ðŸ“‹</span>
                                <span class="doc-title">SPECIFICATIONS</span>
                            </div>
                            <div class="specifications-content">
                                <p class="section-content">{{ selected_project.specifications|linebreaks }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="document-links">
                        {% if selected_project.github_url %}
                        <a href="{{ selected_project.github_url }}" target="_blank" class="document-link">GITHUB</a>
                        {% endif %}
                        {% if selected_project.live_url %}
                        <a href="{{ selected_project.live_url }}" target="_blank" class="document-link">LIVE DEMO</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="dossier-empty">
            <p class="empty-message">NO FILES FOUND</p>
            <p class="empty-subtitle">Dossier is empty</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const folderTabs = document.querySelectorAll('.folder-tab');
        const tabsContainer = document.querySelector('.dossier-folder-tabs');
        const moreTabsTab = document.getElementById('more-tabs-tab');
        const tabsDropdown = document.getElementById('tabs-dropdown');
        const dropdownClose = document.getElementById('dropdown-close');
        const dropdownItems = document.querySelectorAll('.dropdown-item');
        const moreTabsCount = document.getElementById('more-tabs-count');
        
        // Function to manage visible tabs (max 4 visible)
        function manageTabs() {
            if (!tabsContainer || !moreTabsTab || !folderTabs) return;
            
            const MAX_VISIBLE_TABS = 4;
            const totalTabs = folderTabs.length;
            let visibleTabs = [];
            let hiddenTabs = [];
            let activeTabIndex = -1;
            
            // Find active tab and separate visible/hidden tabs
            folderTabs.forEach(function(tab, index) {
                const tabIndex = parseInt(tab.getAttribute('data-project-index')) || (index + 1);
                const isActive = tab.classList.contains('active');
                
                if (isActive) {
                    activeTabIndex = tabIndex;
                }
                
                if (tabIndex <= MAX_VISIBLE_TABS) {
                    // First 4 tabs are always visible
                    tab.classList.remove('hidden-tab');
                    visibleTabs.push(tab);
                } else {
                    // Hide tabs beyond the first 4
                    tab.classList.add('hidden-tab');
                    hiddenTabs.push(tab);
                }
            });
            
            // If active tab is beyond the first 4, show it and hide the 4th tab
            if (activeTabIndex > MAX_VISIBLE_TABS && activeTabIndex <= totalTabs) {
                // Show active tab
                const activeTab = Array.from(folderTabs).find(tab => 
                    parseInt(tab.getAttribute('data-project-index')) === activeTabIndex
                );
                if (activeTab) {
                    activeTab.classList.remove('hidden-tab');
                    // Hide the 4th tab to make room
                    const fourthTab = Array.from(folderTabs).find(tab => 
                        parseInt(tab.getAttribute('data-project-index')) === 4
                    );
                    if (fourthTab && !fourthTab.classList.contains('active')) {
                        fourthTab.classList.add('hidden-tab');
                    }
                }
            }
            
            // Show/hide more tabs indicator
            const hiddenCount = totalTabs - MAX_VISIBLE_TABS;
            if (hiddenCount > 0) {
                moreTabsTab.style.display = 'flex';
                moreTabsCount.textContent = hiddenCount;
            } else {
                moreTabsTab.style.display = 'none';
            }
        }
        
        // Manage tabs on load and when active tab changes
        manageTabs();
        window.addEventListener('resize', manageTabs);
        
        // Re-manage tabs after navigation
        manageTabs();
        
        // Handle folder tab clicks
        folderTabs.forEach(function(tab) {
            tab.addEventListener('click', function() {
                const projectId = this.getAttribute('data-project-id');
                const url = new URL(window.location);
                url.searchParams.set('project', projectId);
                window.location.href = url.toString();
            });
        });
        
        // Handle more tabs tab click
        if (moreTabsTab) {
            moreTabsTab.addEventListener('click', function(e) {
                e.stopPropagation();
                if (tabsDropdown.classList.contains('show')) {
                    tabsDropdown.classList.remove('show');
                    moreTabsTab.classList.remove('active');
                } else {
                    tabsDropdown.classList.add('show');
                    moreTabsTab.classList.add('active');
                }
            });
        }
        
        // Handle dropdown close
        if (dropdownClose) {
            dropdownClose.addEventListener('click', function() {
                tabsDropdown.classList.remove('show');
                moreTabsTab.classList.remove('active');
            });
        }
        
        // Handle dropdown item clicks
        dropdownItems.forEach(function(item) {
            item.addEventListener('click', function() {
                const projectId = this.getAttribute('data-project-id');
                const url = new URL(window.location);
                url.searchParams.set('project', projectId);
                window.location.href = url.toString();
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (tabsDropdown && tabsDropdown.classList.contains('show')) {
                if (!tabsDropdown.contains(e.target) && 
                    !moreTabsTab.contains(e.target)) {
                    tabsDropdown.classList.remove('show');
                    moreTabsTab.classList.remove('active');
                }
            }
        });
    });
</script>
{% endblock %}
